<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Megalodon: Efficient LLM Pretraining and Inference with Unlimited Context Length # Authors: Xuezhe Ma, Xiaomeng Yang, Wenhan Xiong, Beidi Chen, Lili Yu, Hao Zhang, Jonathan May, Luke Zettlemoyer, Omer Levy, Chunting Zhou
Reviewer: Hyunho Kook
1. Introduction # Recently, Large Language Models (LLMs) have been gaining popularity. The impressive performance and versatility demonstrated by large models above a certain level have started to be utilized in various fields. However, as the size of the models grows, the size of the data that the models are expected to process is also increasing.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/spring24/10_/">
  <meta property="og:site_name" content="Efficient ML Systems">
  <meta property="og:title" content="Efficient ML Systems">
  <meta property="og:description" content="Megalodon: Efficient LLM Pretraining and Inference with Unlimited Context Length # Authors: Xuezhe Ma, Xiaomeng Yang, Wenhan Xiong, Beidi Chen, Lili Yu, Hao Zhang, Jonathan May, Luke Zettlemoyer, Omer Levy, Chunting Zhou
Reviewer: Hyunho Kook
1. Introduction # Recently, Large Language Models (LLMs) have been gaining popularity. The impressive performance and versatility demonstrated by large models above a certain level have started to be utilized in various fields. However, as the size of the models grows, the size of the data that the models are expected to process is also increasing.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="website">
<title>10 | Efficient ML Systems</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="canonical" href="http://localhost:1313/docs/spring24/10_/">
<link rel="stylesheet" href="/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css" integrity="sha256-MJt&#43;0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.af197d9d29d888c2e34c92194c94bf3d4b7988ad8214a25d790d7f1995afa08e.js" integrity="sha256-rxl9nSnYiMLjTJIZTJS/PUt5iK2CFKJdeQ1/GZWvoI4=" crossorigin="anonymous"></script>

  

<link rel="alternate" type="application/rss+xml" href="http://localhost:1313/docs/spring24/10_/index.xml" title="Efficient ML Systems" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Efficient ML Systems</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8c2bdf4d8f82cc2d8f16541464d61b3d" class="toggle" checked />
    <label for="section-8c2bdf4d8f82cc2d8f16541464d61b3d" class="flex justify-between">
      <a role="button" class="">Spring24</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/00_taco_example/" class="">00 Taco Example</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/01_/" class="">01</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/02_/" class="">02</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/03_/" class="">03</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/04_/" class="">04</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/05_/" class="">05</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/06_/" class="">06</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/07_/" class="">07</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/08_/" class="">08</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/09_/" class="">09</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/10_/" class="active">10</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/11_/" class="">11</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/12_/" class="">12</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/13_/" class="">13</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/14_/" class="">14</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/15_/" class="">15</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/16_/" class="">16</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/17_/" class="">17</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/18_/" class="">18</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/19_/" class="">19</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/20_/" class="">20</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/21_/" class="">21</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/22_/" class="">22</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/23_/" class="">23</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/24_/" class="">24</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/spring24/25_/" class="">25</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>10</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#1-introduction">1. Introduction</a></li>
    <li><a href="#2-mega-exponential-moving-average-with-gated-attention">2. MEGA (exponential Moving avErage with Gated Attention)</a>
      <ul>
        <li><a href="#2a-moving-average-with-damping">2.a Moving Average with Damping</a></li>
        <li><a href="#2b-generating-query-and-key">2.b Generating Query and Key</a></li>
        <li><a href="#2c-attention-output-calculation">2.c Attention Output Calculation</a></li>
        <li><a href="#2d-gating-mechanisms">2.d Gating Mechanisms</a></li>
        <li><a href="#2e-chunk-wise-attention-for-linear-time-complexity">2.e Chunk-wise Attention for Linear Time Complexity</a></li>
        <li><a href="#2f-limitations-and-future-directions">2.f Limitations and Future Directions</a></li>
      </ul>
    </li>
    <li><a href="#3-methods">3. Methods</a>
      <ul>
        <li><a href="#3a-cema-extending-multi-dimensional-damped-ema-to-complex-domain">3.a CEMA (Extending Multi-dimensional Damped EMA to Complex Domain)</a></li>
        <li><a href="#3b-timestep-normalization">3.b Timestep Normalization</a></li>
        <li><a href="#3c-normalized-attention">3.c Normalized Attention</a></li>
        <li><a href="#3d-2-hop-residual-connection">3.d 2-hop Residual Connection</a></li>
        <li><a href="#3e-summary-of-methods">3.e Summary of Methods</a></li>
      </ul>
    </li>
    <li><a href="#4-experiments">4. Experiments</a>
      <ul>
        <li><a href="#4a-short-context-evaluation">4.a Short-Context Evaluation</a></li>
        <li><a href="#4b-long-context-evaluation">4.b Long-Context Evaluation</a></li>
        <li><a href="#4c-instuction-finetuning">4.c Instuction Finetuning</a></li>
        <li><a href="#4d-medium-scale-benchmarks">4.d Medium-scale Benchmarks</a></li>
        <li><a href="#4e-summary-of-experiments">4.e Summary of Experiments</a></li>
      </ul>
    </li>
    <li><a href="#5-comparison-with-related-works">5. Comparison with related works</a></li>
    <li><a href="#6-discussion">6. Discussion</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="megalodon-efficient-llm-pretraining-and-inference-with-unlimited-context-length">
  Megalodon: Efficient LLM Pretraining and Inference with Unlimited Context Length
  <a class="anchor" href="#megalodon-efficient-llm-pretraining-and-inference-with-unlimited-context-length">#</a>
</h1>
<p>Authors: Xuezhe Ma, Xiaomeng Yang, Wenhan Xiong, Beidi Chen, Lili Yu, Hao Zhang, Jonathan May, Luke Zettlemoyer, Omer Levy, Chunting Zhou</p>
<p>Reviewer: Hyunho Kook</p>
<p><img src="./Megalodon.jpg" alt="Megalodon" /></p>
<h2 id="1-introduction">
  1. Introduction
  <a class="anchor" href="#1-introduction">#</a>
</h2>
<p>Recently, Large Language Models (LLMs) have been gaining popularity. The impressive performance and versatility demonstrated by large models above a certain level have started to be utilized in various fields. However, as the size of the models grows, the size of the data that the models are expected to process is also increasing. Examples of this include processing currently open issues by inputting a GitHub repository or translating a large volume of books without losing context. In addition, the ability to maintain context and carry on a conversation for an extended period within a single chat is also sometimes required. The transformer, which is the foundation model of modern LLMs, exhibits vulnerabilities in this regard. Firstly, since it uses KV cache, memory usage increases rapidly as the sequence length grows, and it has a computational complexity proportional to the square of the sequence length.</p>
<p>To address this problem, the authors propose a method that inherits and advances MEGA (exponential moving average with gated attention), the predecessor of this paper. The overall contributions are as follows:</p>
<ol>
<li><strong>CEMA (Extending Multi-dimensional Damped EMA to Complex Domain)</strong>, an extension of Exponential Moving Average (EMA) to the complex domain, is proposed.</li>
<li><strong>Timestep Normalization, an extension of Group Norm to the timestep domain</strong>, is proposed as an alternative to Layer Norm.</li>
<li><strong>Normalized Attention</strong>, which performs normalization during attention computation, is proposed.</li>
<li><strong>2-hop Residual Connection</strong>, which composes residual connections in 2-hop units, is proposed.</li>
</ol>
<p>By employing these methods, the authors have created a transformer architecture that is linear with respect to context length. They have also addressed the issues encountered in the previous research, MEGA, which were (i) low performance and (ii) the need for different architecture structures for each data type or task.</p>
<h2 id="2-mega-exponential-moving-average-with-gated-attention">
  2. MEGA (exponential Moving avErage with Gated Attention)
  <a class="anchor" href="#2-mega-exponential-moving-average-with-gated-attention">#</a>
</h2>
<p>Before diving into the main contributions of our work, it&rsquo;s essential to grasp the concepts behind MEGA (Moving Average with Gating Attention), a technique that serves as a stepping stone towards more efficient transformer models. MEGA leverages the moving average with damping to enhance the attention mechanism. Let&rsquo;s break it down step by step.</p>
<h3 id="2a-moving-average-with-damping">
  2.a Moving Average with Damping
  <a class="anchor" href="#2a-moving-average-with-damping">#</a>
</h3>
<p>At the core of MEGA lies the moving average with damping, which can be expressed by the following equations:</p>

<link rel="stylesheet" href="/katex/katex.min.css" />
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script><span>
  \(\begin{align*}
u_t^{(j)} &amp;= \beta_j x_{t,j} \\
h_t^{(j)} &amp;= \alpha_j \odot u_t^{(j)} &#43; (1 - \alpha_j \odot \delta_j) \odot h_{t-1}^{(j)} \\
y_{t,j} &amp;= \eta_j^T h_t^{(j)}
\end{align*}\)
</span>

<p>This exponential moving average (EMA) serves as the foundation for the subsequent attention mechanism.</p>
<h3 id="2b-generating-query-and-key">
  2.b Generating Query and Key
  <a class="anchor" href="#2b-generating-query-and-key">#</a>
</h3>
<p>The EMA is then fed into the attention mechanism to generate the Query and Key matrices after applying the SiLU activation function. First, we calculate the shared representation <span>
  \(Z\)
</span>
 using the EMA of the input <span>
  \(X\)
</span>
:</p>
<span>
  \(\begin{align*}
X&#39; &amp;= EMA(X) \in \mathbb{R}^{n \times d} \\
Z &amp;= \phi_{silu}(X&#39;W_z &#43; b_z) \in \mathbb{R}^{n \times z}
\end{align*}\)
</span>

<p>Using the shared representation <span>
  \(Z\)
</span>
, we can now compute the queries and keys. It&rsquo;s important to note that the original input <span>
  \(X\)
</span>
 is used to calculate the values:</p>
<span>
  \(\begin{align*}
Q &amp;= \kappa_q \odot Z &#43; \mu_q \in \mathbb{R}^{n \times z}\\
K &amp;= \kappa_k \odot Z &#43; \mu_k \in \mathbb{R}^{n \times z}\\
V &amp;= \phi_{silu}(XW_v &#43; b_v) \in \mathbb{R}^{n \times v}
\end{align*}\)
</span>

<h3 id="2c-attention-output-calculation">
  2.c Attention Output Calculation
  <a class="anchor" href="#2c-attention-output-calculation">#</a>
</h3>
<p>After obtaining the Query, Key, and Value matrices, we can calculate the output of the attention mechanism using the standard formula:</p>
<span>
  \(O = f\left(\frac{QK^T}{\tau(X)}\right)V \in \mathbb{R}^{n \times v}\)
</span>

<p>Here, <span>
  \(f\)
</span>
 is typically the softmax function, and <span>
  \(\tau\)
</span>
 is a temperature function based on the input <span>
  \(X\)
</span>
.</p>
<h3 id="2d-gating-mechanisms">
  2.d Gating Mechanisms
  <a class="anchor" href="#2d-gating-mechanisms">#</a>
</h3>
<p>MEGA employs gating mechanisms, similar to the Gated Linear Unit (GLU), to generate the final output <span>
  \(Y\)
</span>
 and the internal activation <span>
  \(\hat{H}\)
</span>
. This is achieved through the following equations:</p>
<span>
  \(\begin{align*}
\gamma &amp;= \phi_{silu}(X&#39;W_\gamma &#43; b_\gamma) \in \mathbb{R}^{n \times v} \\
\varphi &amp;= \phi_{sigmoid}(X&#39;W_\varphi &#43; b_\varphi) \in \mathbb{R}^{n \times d} \\ 
\hat{H} &amp;= \phi_{silu}(X&#39;W_h &#43; (\gamma \odot O)U_h &#43; b_h) \in \mathbb{R}^{n \times d} \\
Y &amp;= \varphi \odot \hat{H} &#43; (1 - \varphi) \odot X \in \mathbb{R}^{n \times d}
\end{align*}\)
</span>

<h3 id="2e-chunk-wise-attention-for-linear-time-complexity">
  2.e Chunk-wise Attention for Linear Time Complexity
  <a class="anchor" href="#2e-chunk-wise-attention-for-linear-time-complexity">#</a>
</h3>
<p><img src="./Mega.png" alt="Mega" /></p>
<p>To reduce the time complexity to a linear function of O(nc), MEGA employs chunk-wise attention, as illustrated in the figure above. By maintaining an internal accumulation of information and processing the input in chunks, MEGA enables transformers to achieve comparable performance on long context datasets.</p>
<h3 id="2f-limitations-and-future-directions">
  2.f Limitations and Future Directions
  <a class="anchor" href="#2f-limitations-and-future-directions">#</a>
</h3>
<p><img src="./Mega_table.png" alt="Mega_table" /></p>
<p>Despite its benefits, MEGA still faces two primary challenges:</p>
<ol>
<li>Performance falls short compared to typical transformers with full attention.</li>
<li>Different architectures are required for different tasks.</li>
</ol>
<p>Moreover, the effectiveness of MEGA in large-scale networks remains to be demonstrated conclusively.</p>
<p>In the following sections, we will explore how our proposed approach addresses these limitations and pushes the boundaries of efficient transformer models.</p>
<h2 id="3-methods">
  3. Methods
  <a class="anchor" href="#3-methods">#</a>
</h2>
<p>Now, this paper, Megalodon, proposes four different methods that makes a network have even better performance than the baseline, while it can be applied for general cases.</p>
<h3 id="3a-cema-extending-multi-dimensional-damped-ema-to-complex-domain">
  3.a CEMA (Extending Multi-dimensional Damped EMA to Complex Domain)
  <a class="anchor" href="#3a-cema-extending-multi-dimensional-damped-ema-to-complex-domain">#</a>
</h3>
<p>To improve EMA (Exponential Moving Average) capability when working over the complex number system, the authors propose CEMA (Complex Exponential Moving Average), which extends the idea of EMA to the complex plane. The key equations for CEMA are:</p>
<span>
  \(\begin{align*}
h_t^{(j)} &amp;= \alpha_j(\cos \theta_j &#43; i \sin \theta_j) \odot u_t^{(j)} &#43; (1 - \alpha_j \odot \delta_j)(\cos \theta_j &#43; i \sin \theta_j) \odot h_{t-1}^{(j)} \\
y_{t,j} &amp;= \mathcal{Re}(\eta_j^T h_t^{(j)})
\end{align*}\)
</span>

<p>Here, <span>
  \(\alpha\)
</span>
 and <span>
  \(\delta\)
</span>
 are real-valued parameters, just like in the original EMA. However, <span>
  \(\eta\)
</span>
 is a complex-valued parameter in CEMA. The <span>
  \(\theta_j\)
</span>
 values are learnable parameters that are used to uniformly distribute the <span>
  \(h\)
</span>
 arguments over the period of <span>
  \(2\pi\)
</span>
. This is achieved by parameterizing <span>
  \(\theta_j\)
</span>
 as:</p>
<span>
  \(\theta_{j,k} = \frac{2\pi k}{h} \omega_j, \quad \forall k \in {1, 2, \dots, h}\)
</span>

<p>where <span>
  \(\omega\)
</span>
 is a learnable parameter that determines the base angles.</p>
<p>The introduction of complex numbers in CEMA allows it to capture positional features of internal embeddings without changing the magnitude of <span>
  \(h\)
</span>
. Instead, it periodically changes the angle in the complex domain. This makes CEMA a powerful tool for modeling long sequences and improving the capability of EMA in complex-valued systems.</p>
<h3 id="3b-timestep-normalization">
  3.b Timestep Normalization
  <a class="anchor" href="#3b-timestep-normalization">#</a>
</h3>
<p><img src="./Timestep_norm.png" alt="Timestep_norm" /></p>
<p>Transformer-based models typically use Layer Normalization (LayerNorm) instead of Batch Normalization (BatchNorm) due to the significant variation in input batch sizes across different timesteps. While this approach has led to great success in large language models, the authors argue that LayerNorm cannot effectively capture and reduce the internal covariance along the temporal domain. To address this issue, they propose using a GroupNorm-like method. However, applying GroupNorm directly is challenging because it cannot access future information during auto-regressive inference.</p>
<p>To overcome this obstacle, the authors introduce Timestep Normalization, a superset of GroupNorm. This technique divides the total timesteps into <span>
  \(k\)
</span>
 groups and applies group normalization to each group independently. By doing so, Timestep Normalization can reduce the covariance shift along the temporal domain while still being compatible with the causal nature of auto-regressive models.</p>
<h3 id="3c-normalized-attention">
  3.c Normalized Attention
  <a class="anchor" href="#3c-normalized-attention">#</a>
</h3>
<p>During the calculation of attentions, the results can have a hugh instability along the temporal domain because the value of CEMA keeps changing. Therfore, the authors propose to use normalizaion on <span>
  \(Z\)
</span>
 before calculating the queries and keys. In this case, we do not have to scale the <span>
  \(QK^{T}\)
</span>
 since the values are already normalized while improving the stability of the attention mechanism.</p>
<span>
  \(\begin{align*}
X&#39; &amp;= \mathcal{CEMA}(X) &amp;&amp; \in \mathbb{R}^{n \times d} \\
Z &amp;= X&#39;W_z &#43; b_z, \quad Z&#39; = \frac{Z}{|Z|} &amp;&amp; \in \mathbb{R}^{n \times z} \\
Q &amp;= \kappa_q \odot Z&#39; &#43; \mu_q &amp;&amp; \in \mathbb{R}^{n \times z} \\
K &amp;= \kappa_k \odot Z&#39; &#43; \mu_k &amp;&amp; \in \mathbb{R}^{n \times z} \\
O &amp;= f_{\text{softmax}}\left(QK^T\right)V &amp;&amp; \in \mathbb{R}^{n \times v}
\end{align*}\)
</span>

<h3 id="3d-2-hop-residual-connection">
  3.d 2-hop Residual Connection
  <a class="anchor" href="#3d-2-hop-residual-connection">#</a>
</h3>
<p><img src="./Architecture.png" alt="Architecture" /></p>
<p>Finnally, the last contribution of this paper is the use of the 2-hop residual connection. The authors point out that pre-normalizaion can achieve more stable training in deep learning, this can further lead instability when scaling up the model size. Therefore, to reduce the instability, this paper uses 2-hop residual connections which propagate the input to the end of the layer without modifying it.</p>
<h3 id="3e-summary-of-methods">
  3.e Summary of Methods
  <a class="anchor" href="#3e-summary-of-methods">#</a>
</h3>
<p>The main contribution of this paper lies in the application of CEMA (Complex Exponential Moving Average), which effectively captures the positional information of internal embeddings (<span>
  \(H\)
</span>
) by incorporating a circular system in the complex domain. By using periodic functions like sine and cosine, CEMA can encode the sequential nature of the input data, allowing the model to better understand and utilize the temporal dependencies.</p>
<p>However, the introduction of complex numbers in CEMA doubles the dimensionality of the variables, which can potentially lead to significant instability during the training process. To address this issue, the authors propose three additional methods: Timestep Normalization, Normalized Attention, and 2-hop Residual Connection. These techniques work in conjunction with CEMA to stabilize the training process and ensure the model&rsquo;s robustness.</p>
<ol>
<li>
<p>Timestep Normalization is employed to reduce the covariance shift along the temporal domain while maintaining compatibility with the causal nature of auto-regressive models. By normalizing the activations within each timestep group, this method helps to mitigate the impact of the increased dimensionality introduced by CEMA.</p>
</li>
<li>
<p>Normalized Attention is used to stabilize the attention mechanism by properly scaling the attention weights. This prevents extreme values that could otherwise destabilize the training process, ensuring that the model can learn effectively from the input data.</p>
</li>
<li>
<p>2-hop Residual Connection provides a more direct path for gradient flow, allowing the model to propagate information more efficiently during the backward pass. This helps to alleviate the vanishing gradient problem and facilitates faster convergence of the model.</p>
</li>
</ol>
<p>These three methods work in harmony with CEMA to counterbalance the potential instability caused by the increased dimensionality. By carefully integrating these techniques, the authors aim to create a robust and effective model that can leverage the benefits of CEMA while maintaining stable training dynamics.</p>
<p>In essence, while CEMA is the primary contribution of this paper, the additional methods proposed by the authors play a crucial role in ensuring the model&rsquo;s stability and performance. The combination of CEMA with Timestep Normalization, Normalized Attention, and 2-hop Residual Connection demonstrates a well-rounded approach to tackling the challenges associated with modeling sequential data in the complex domain.</p>
<h2 id="4-experiments">
  4. Experiments
  <a class="anchor" href="#4-experiments">#</a>
</h2>
<p>In most cases, the authors try to compare the proposed idea with the LLAMA2-7B model. They use MEGALODON-7B model and use the same amount of training tokens to pre-train it. They try to show that MEGALODON can not only achieve the higher performance on long context datasets, but also show superior skills on short context problems than a naive transformer architecture.</p>
<h3 id="4a-short-context-evaluation">
  4.a Short-Context Evaluation
  <a class="anchor" href="#4a-short-context-evaluation">#</a>
</h3>
<p><img src="./figure1.png" alt="figure1" /></p>
<p><img src="./table1.png" alt="table1" /></p>
<p>The authors first show the loss during training and the performance on short context datasets during inference. The proposed method can achieve training loss between LLAMA-7b and LLAMA-13b with 7b parameters. Furthermore, if you look at the table 1, then during inference the MEGALODON-7B truly show the performance between LLAMA-7b and LLAMA-13b. This proves that MEGALODON can ahieve better performance than the original model unlike the previous work, MEGA.</p>
<h3 id="4b-long-context-evaluation">
  4.b Long-Context Evaluation
  <a class="anchor" href="#4b-long-context-evaluation">#</a>
</h3>
<p><img src="./table2.png" alt="table2" /></p>
<p>To verify the performance on long context datasets, the authors provide two results. The figure 5 describes that if the context length increases, then the MEGALODON can truly output lower PPL answers. Then, the table 2 shows the performance on a long context benchmark, Scrolls. Although the LLAMA2 can show slightly better performance when it is finetuned for long context datasets with 500B tokens, the MEGALODON can show comparable accuracies without applying any fine-tuning techniques.</p>
<h3 id="4c-instuction-finetuning">
  4.c Instuction Finetuning
  <a class="anchor" href="#4c-instuction-finetuning">#</a>
</h3>
<p><img src="./table3.png" alt="table3" /></p>
<p>The authors also prove that MEGALODON can have a generalization power by testing the pre-trained model on MT-Bench. They do not utilized further techniques such as RLHF during fine-tuning for a specific instruction. They show a comparable or sometimes competitive performance.</p>
<h3 id="4d-medium-scale-benchmarks">
  4.d Medium-scale Benchmarks
  <a class="anchor" href="#4d-medium-scale-benchmarks">#</a>
</h3>
<p><img src="./table4.png" alt="table4" /></p>
<p>Finnally, the authors prove that the MEGALODON can show competitive performance compared to the previous long-context-agnostic models on general benchmarks. Inside the table 4 and 5, the MEGALODON achieves highest performance on ImageNet classifcation task and medium-scale benchmakr (PG-19).</p>
<h3 id="4e-summary-of-experiments">
  4.e Summary of Experiments
  <a class="anchor" href="#4e-summary-of-experiments">#</a>
</h3>
<p>In the experiment part, the authors try to prove that the MEGALODON can have the features that have been proven for the previous foundation models, while showing superior performance on long context benchmarks. This implies that the MEGALODON is not a sophisticately tuned model for long contexts.</p>
<h2 id="5-comparison-with-related-works">
  5. Comparison with related works
  <a class="anchor" href="#5-comparison-with-related-works">#</a>
</h2>
<p>There have been several similar related studies:</p>
<ol>
<li>
<p>Efficient Attention: FlashAttention optimized the GPU computation of the attention, showing advantages in speed without changing the existing mechanism. Additionally, there have been attempts to increase the context length by converting the attention mechanism to a linear one or compressing the KV cache.</p>
</li>
<li>
<p>Structured State Space Model: A notable study in this area is Mamba, which added mechanisms like Selective Scan to a State Space model with linear time complexity, enabling it to process long context.</p>
</li>
</ol>
<p>However, these studies have limitations. Even if we accept that Flash Attention did not change the attention mechanism itself, Linear Attention, KV cache compression, and State Space Models have shown significantly lower performance on general benchmarks, although they may perform better than standard Transformers in long contexts.</p>
<h2 id="6-discussion">
  6. Discussion
  <a class="anchor" href="#6-discussion">#</a>
</h2>
<p>In my opinion, there are a few potential limitations that are not extensively discussed in the paper:</p>
<ol>
<li>
<p><strong>Reliance on CEMA for Out-of-Chunk Context</strong>: The self-attention mechanism in MEGALODON is applied within each chunk. For data that falls completely outside the chunk boundaries, the model relies solely on CEMA for processing. This limitation could potentially hinder the model&rsquo;s ability to handle long-range dependencies that span across multiple chunks.</p>
</li>
<li>
<p><strong>Complexity of the Architecture</strong>: Compared to the traditional Transformer layer, the MEGALODON architecture is considerably more complex. It requires the computation of EMA, including the complex domain, for each token. Additionally, several normalization and attention components have been introduced, such as Timestep Normalization, which further increases the complexity of the model compared to the previous works.</p>
</li>
<li>
<p><strong>Limited Exploration of Downstream Tasks</strong>: While the paper demonstrates the effectiveness of MEGALODON on long-context question answering tasks from the Scrolls dataset, the range of downstream tasks explored is relatively narrow. Evaluating the model&rsquo;s performance on a broader set of tasks, such as summarization, dialogue generation, and composition, would provide a more comprehensive assessment of its capabilities and potential limitations.</p>
</li>
</ol>
<p>Despite these limitations, MEGALODON presents a promising direction for efficient long-context modeling. In my opinion, this kind of efficent and linear processing of <strong>memory</strong> can be a breakthrough for long-context LLMs.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/effml-postech/blog-post/commit/523a542a953a9e37fca5b3c63380cee2c7a1a2e4" title='Last modified by kookhh0827 | May 23, 2024' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="" />
      <span>May 23, 2024</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/effml-postech/blog-post/edit/main//content/docs/spring24/10_/_index.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#1-introduction">1. Introduction</a></li>
    <li><a href="#2-mega-exponential-moving-average-with-gated-attention">2. MEGA (exponential Moving avErage with Gated Attention)</a>
      <ul>
        <li><a href="#2a-moving-average-with-damping">2.a Moving Average with Damping</a></li>
        <li><a href="#2b-generating-query-and-key">2.b Generating Query and Key</a></li>
        <li><a href="#2c-attention-output-calculation">2.c Attention Output Calculation</a></li>
        <li><a href="#2d-gating-mechanisms">2.d Gating Mechanisms</a></li>
        <li><a href="#2e-chunk-wise-attention-for-linear-time-complexity">2.e Chunk-wise Attention for Linear Time Complexity</a></li>
        <li><a href="#2f-limitations-and-future-directions">2.f Limitations and Future Directions</a></li>
      </ul>
    </li>
    <li><a href="#3-methods">3. Methods</a>
      <ul>
        <li><a href="#3a-cema-extending-multi-dimensional-damped-ema-to-complex-domain">3.a CEMA (Extending Multi-dimensional Damped EMA to Complex Domain)</a></li>
        <li><a href="#3b-timestep-normalization">3.b Timestep Normalization</a></li>
        <li><a href="#3c-normalized-attention">3.c Normalized Attention</a></li>
        <li><a href="#3d-2-hop-residual-connection">3.d 2-hop Residual Connection</a></li>
        <li><a href="#3e-summary-of-methods">3.e Summary of Methods</a></li>
      </ul>
    </li>
    <li><a href="#4-experiments">4. Experiments</a>
      <ul>
        <li><a href="#4a-short-context-evaluation">4.a Short-Context Evaluation</a></li>
        <li><a href="#4b-long-context-evaluation">4.b Long-Context Evaluation</a></li>
        <li><a href="#4c-instuction-finetuning">4.c Instuction Finetuning</a></li>
        <li><a href="#4d-medium-scale-benchmarks">4.d Medium-scale Benchmarks</a></li>
        <li><a href="#4e-summary-of-experiments">4.e Summary of Experiments</a></li>
      </ul>
    </li>
    <li><a href="#5-comparison-with-related-works">5. Comparison with related works</a></li>
    <li><a href="#6-discussion">6. Discussion</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












